# Project Context - Rust
# Generated by: asimov init --type rust
# This file contains project-specific configuration.
# Behavior protocols are hardcoded in the asimov binary.

identity:
  name: "forge-demo"
  type: rust
  version: "1.0.0"
  tagline: "AI hallucinates numbers. Forge doesn't."

# ═══════════════════════════════════════════════════════════════════════════════
# FORGE CONTEXT
# ═══════════════════════════════════════════════════════════════════════════════
# forge-e2e validates the forge-demo binary from royalbit/forge
# This section documents how forge-demo works for E2E test development

forge:
  description: |
    Forge is a YAML-based financial calculator with Excel formula evaluation.
    It uses Rust feature flags to create demo and enterprise builds.

  source: "../forge"  # local sibling directory (internal, not on GitHub)

  builds:
    demo:
      binary: "forge-demo"
      command: "cargo build --release --bin forge-demo"
      features: []
      functions: 37
      schema: "v1.0.0 only"
    enterprise:
      binary: "forge"
      command: "cargo build --release --features full"
      features: ["full"]
      functions: 154
      schema: "v1.0.0, v5.0.0"

  # Quick reference:
  # | Build      | Command                               | Binary     | Functions |
  # |------------|---------------------------------------|------------|-----------|
  # | Demo       | cargo build --release                 | forge-demo | 37        |
  # | Enterprise | cargo build --release --features full | forge      | 154       |

  demo_functions:
    math: ["ABS", "SQRT", "ROUND", "ROUNDUP", "ROUNDDOWN", "FLOOR", "CEILING", "MOD", "POWER"]
    aggregation: ["SUM", "AVERAGE", "MIN", "MAX", "COUNT"]
    logical: ["IF", "AND", "OR", "NOT", "IFERROR"]
    text: ["CONCAT", "LEFT", "RIGHT", "MID", "LEN", "UPPER", "LOWER", "TRIM", "REPT"]
    date: ["TODAY", "DATE", "YEAR", "MONTH", "DAY", "DATEDIF"]
    lookup: ["INDEX", "MATCH", "CHOOSE"]

  schema_v1:
    description: "Scalar-only model (no arrays, no tables)"
    required: "_forge_version: '1.0.0'"
    structure:
      - "scalars: Single values or formulas"
      - "assumptions: ScalarGroup (value/formula pairs)"
      - "scenarios: Named variable overrides (scalar values)"
    note: "v1.0.0 does NOT support arrays or tables. Use v5.0.0 for enterprise features."
    example: |
      _forge_version: "1.0.0"
      assumptions:
        revenue:
          value: 1000000
          formula: null
        gross_profit:
          value: null
          formula: "=revenue * 0.6"

  cli_commands:
    - "calculate <file.yaml> - Execute formulas, update values"
    - "validate <file.yaml> - Check model integrity"
    - "export <file.yaml> <output.xlsx> - YAML → Excel with formulas"
    - "import <file.xlsx> <output.yaml> - Excel → YAML"
    - "audit <file.yaml> <variable> - Trace formula dependencies"
    - "functions - List all supported functions"

  validation_flow: |
    E2E validation compares Forge output against Gnumeric/LibreOffice:
    1. forge-demo export model.yaml output.xlsx → Excel with formulas
    2. ssconvert --recalc output.xlsx output.csv → spreadsheet recalculates
       (or: libreoffice --headless --convert-to csv)
    3. Parse CSV, compare Forge values vs spreadsheet values
    4. Exact match required (no tolerance - this is a financial tool)

# ═══════════════════════════════════════════════════════════════════════════════
# FORGE-E2E SPECIFICATION
# ═══════════════════════════════════════════════════════════════════════════════

forge_e2e:
  description: "E2E validation tool for forge-demo"

  cli_modes:
    default: "TUI mode (ratatui) - interactive progress display"
    all: "--all flag - verbose headless, colored YAML output to terminal"

  test_specs:
    format: "YAML (not TOML)"
    location: "tests/e2e/*.yaml"
    structure: |
      # Example test spec
      _forge_version: "1.0.0"
      assumptions:
        test_abs_positive:
          value: null
          formula: "=ABS(-42)"
          expected: 42  # forge-e2e compares this
        test_sum:
          value: null
          formula: "=SUM(1, 2, 3)"
          expected: 6

  comparison:
    tolerance: "none (exact match - financial tool)"
    on_mismatch: "Show expected vs got with colored diff"

  engine_detection:
    priority:
      1: "ssconvert (Gnumeric) - preferred, properly recalculates with --recalc"
      2: "libreoffice --headless - fallback"
    paths_checked:
      gnumeric: ["ssconvert"]
      libreoffice:
        - "/usr/bin/soffice"
        - "/usr/bin/libreoffice"
        - "/Applications/LibreOffice.app/Contents/MacOS/soffice"
        - "/snap/bin/libreoffice"
        - "soffice"
        - "libreoffice"

  scripts:
    run_demo: |
      ./run-demo.sh - Downloads latest forge-e2e from GitHub releases and runs it
      - Detects platform (aarch64-apple-darwin, x86_64-unknown-linux-gnu, etc.)
      - Downloads from: https://github.com/royalbit/forge-demo/releases/latest/download/{archive}
      - Extracts to bin/forge-e2e
      - Runs: ./bin/forge-e2e (TUI) or ./bin/forge-e2e --all (verbose)

  dependencies:
    - "ratatui - TUI framework"
    - "crossterm - Terminal backend"
    - "serde + serde_yaml - YAML parsing"
    - "tempfile - Temporary files for XLSX/CSV"
    - "colored - Terminal colors for --all mode"

  exit_codes:
    0: "All tests passed"
    1: "One or more tests failed"

quality:
  test: "cargo test"
  lint: "cargo clippy -- -D warnings"
  format: "cargo fmt --check"
  build: "cargo build --release"

files:
  source:
    - "src/main.rs - Entry point"
    - "src/lib.rs - Library root"
  config:
    - "Cargo.toml - Dependencies and metadata"
  docs:
    - "README.md - Project documentation"
  binaries:
    location: "bin/"
    note: "bin/* gitignored, bin/.keep tracked"
    forge_demo:
      description: "Forge demo binary (downloaded from GitHub releases)"
      path: "bin/forge-demo"
      download: "https://github.com/royalbit/forge/releases/latest/download/{archive}"
      platforms:
        aarch64-apple-darwin: "forge-demo-aarch64-apple-darwin.tar.gz"
        x86_64-apple-darwin: "forge-demo-x86_64-apple-darwin.tar.gz"
        x86_64-unknown-linux-gnu: "forge-demo-x86_64-unknown-linux-gnu.tar.gz"
        aarch64-unknown-linux-gnu: "forge-demo-aarch64-unknown-linux-gnu.tar.gz"
        x86_64-pc-windows-msvc: "forge-demo-x86_64-pc-windows-msvc.zip"
    forge_e2e:
      description: "E2E validation tool (built by CI or locally)"
      path: "bin/forge-e2e"
      repo: "royalbit/forge-demo"
      download: "https://github.com/royalbit/forge-demo/releases/latest/download/{archive}"
      platforms:
        aarch64-apple-darwin: "forge-e2e-aarch64-apple-darwin.tar.gz"
        x86_64-apple-darwin: "forge-e2e-x86_64-apple-darwin.tar.gz"
        x86_64-unknown-linux-gnu: "forge-e2e-x86_64-unknown-linux-gnu.tar.gz"
        aarch64-unknown-linux-gnu: "forge-e2e-aarch64-unknown-linux-gnu.tar.gz"
        x86_64-pc-windows-msvc: "forge-e2e-x86_64-pc-windows-msvc.zip"

patterns:
  - "Result<T, E> for errors, no panics"
  - "thiserror for custom errors"
  - "No unwrap() in library code"
  - "Use clippy lints as errors"

release:
  workflow: ".github/workflows/release.yml"
  triggers: "git tag v*"
  platforms:
    - x86_64-unknown-linux-gnu (UPX)
    - aarch64-unknown-linux-gnu
    - x86_64-apple-darwin
    - aarch64-apple-darwin
    - x86_64-pc-windows-msvc (UPX)
  publish:
    - GitHub Releases (binaries + checksums)
  profile: |
    [profile.release]
    opt-level = 3
    lto = true
    codegen-units = 1
    strip = true
    panic = "abort"
  compression: "UPX --best --lzma (Linux/Windows only, breaks macOS signing)"

ci:
  workflow: ".github/workflows/ci.yml"
  jobs:
    - test (cargo test)
    - lint (clippy, fmt)
    - build (all platforms)
    - auto-release (create tag when version changes)

# v9.3.0: Coding standards for Rust projects (ADR-041)
coding_standards:
  code:
    file_size:
      soft_limit: 1000
      hard_limit: 1500
      note: "lines per file - split if exceeding"
    coverage: "100%"
    linting: "clippy pedantic, zero warnings"
    tests: "colocated with code (#[cfg(test)] mod tests)"
    formatting: "rustfmt (cargo fmt)"
  documentation:
    linting: "markdownlint-cli2"
    style:
      - "ATX-style headers (#)"
      - "One sentence per line (for git diffs)"
  architecture:
    decisions: "ADR format in docs/adr/"
    diagrams: "Mermaid preferred (text-based, version controlled)"

# v8.8.0: Standard deliverables for coding projects (ADR-034)
deliverables_template:
  - "[ ] Unit tests pass"
  - "[ ] E2E tests pass (if applicable)"
  - "[ ] cargo clippy -- -D warnings (zero warnings)"
  - "[ ] Update README if needed"
  - "[ ] Update --help if CLI"
  - "[ ] Commit and push"
  - "[ ] GitHub release (if applicable)"
